services:
  frontend:
    build: { context: ./frontend, dockerfile: ../docker/frontend.Dockerfile }
    environment:
      - NEXT_PUBLIC_API_BASE=http://api:8080
    ports: ["3000:3000"]
    depends_on: [api]

  api:
    build: { context: ./api, dockerfile: ../docker/api.Dockerfile }
    environment:
      - DATABASE_URL=postgres://postgres:postgres@db:5432/arxiv?sslmode=disable
      - S3_ENDPOINT=http://minio:9000
      - S3_BUCKET=arxiv
      - QUEUE_URL=redis://redis:6379
      - GROBID_URL=http://grobid:8070
    ports: ["8080:8080"]
    depends_on: [db, minio, redis, grobid]

  worker:
    build: { context: ./worker, dockerfile: ../docker/worker.Dockerfile }
    environment:
      - （api と同じ接続/env）
    depends_on: [db, minio, redis, grobid]

  db:
    image: postgres:16
    environment: [ POSTGRES_PASSWORD=postgres, POSTGRES_DB=arxiv ]
    volumes: [ dbdata:/var/lib/postgresql/data ]

  minio:
    image: minio/minio
    command: server /data --console-address ":9001"
    environment: [ MINIO_ROOT_USER=miniokey, MINIO_ROOT_PASSWORD=miniosecret ]
    ports: ["9000:9000","9001:9001"]
    volumes: [ s3data:/data ]

  redis:
    image: redis:7

  grobid:
    image: lfoppiano/grobid:0.7.3
    ports: ["8070:8070"] # REST: /api/processFulltextDocument
    environment: [ GROBID_CONFIG=/opt/grobid/grobid-home/config/grobid.properties ]

  tesseract:
    image: tesseractshadow/tesseract4re
    # worker から exec で使う or REST ラッパーを用意

volumes:
  dbdata:
  s3data:
